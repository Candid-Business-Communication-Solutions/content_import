<?php

/**
 * @file
 * A module that crawls sites for links and creates nodes out of them.
 */

/**
 * Implements hook_help.
 *
 * Displays help and module information.
 *
 * @param path 
 *   Which path of the site we're using to display help
 * @param arg 
 *   Array that holds the current path as returned from arg() function
 */
function link_import_help($path, $arg) {
  switch ($path) {
    case "admin/help#link_import":
      return '<p>' . t("Imports links and creates nodes form them.") . '</p>';
      break;
  }
} 

/**
 * Implements hook_block_info().
 */

function link_import_block_info() {
  $blocks['link_import'] = array(
    'info' => t('Import Links'), //The name that will appear in the block list.
    'cache' => DRUPAL_CACHE_PER_ROLE, //Default
  );
  return $blocks;
}



/**
 * Implements hook_menu().
 */
function link_import_menu() {
  $items = array();

  $items['admin/config/content/link_import'] = array(
    'title' => 'Import Links',
    'description' => 'Configuration for Link Import module',
    'page callback' => 'drupal_get_form',
    'access callback' => TRUE,
    'page arguments' => array('link_import_config_form'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['link_import'] = array(
    'title' => 'Import Links',
    'description' => 'Set Parameters for Link Importation',
    'page callback' => 'drupal_get_form',
    'access callback' => TRUE,
    'page arguments' => array('link_import_form'),
    //'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
  );  

  return $items;
}

/**
 * Page callback: Link Import settings
 *
 * @see link_import_menu()
 */

function link_import_form($form, &$form_state) {



  $form['urls'] = array(
    "#type" => 'fieldset',
    "#title" => t('URLs'),
    '#weight' => 4, 
    '#collapsible' => TRUE, 
    '#collapsed' => FALSE,
  );

  $form['urls']['batch_name'] = array(
    '#type' => 'textfield',
    '#title' => t('Enter batch name'),
    '#description' => t('Human readable name for batch job.')
    //TODO: check configuration page checkbox to see if batch name is required
  );



	$form['urls']['url_list'] = array(
		'#type' => 'textarea', 
		'#title' => t('URL(s) to page crawl for links'), 
    '#description' => t('Enter one URL per line must include protocol moniker (ex.: http://, ftp://, smb://, etc.)'),
		'#required' => TRUE,
    '#default_value' => t("http://localhost")
	);

	$content_types = node_type_get_names();

	$form['urls']['content_type'] = array(
	   '#type' => 'select',
	   '#title' => t('Select Content Type'),
	   '#options' => drupal_map_assoc($content_types),
     '#default_value' => "Song"
	);

  $form['urls']['taxonomy_list'] = array(
    '#type' => 'select',
    '#title' => 'Select Taxonomy',
    '#options' => get_taxonomy_vocabularies(),
    '#ajax' => array(
      'callback' => 'ajax_terms_callback',
      'wrapper' => 'term-list-div',
      'method' => 'replace'
    )
  );

  $form['urls']['term_list'] = array(
    '#type' => 'select',
    '#description' => 'Term list',
    '#prefix' => '<div id="term-list-div">',
    '#suffix' => '</div>',
    '#options' => drupal_map_assoc(array(t('Select')))
  );

  $form['attachments'] = array(
    "#type" => 'fieldset',
    "#title" => t('Attachments'),
    '#weight' => 5, 
    '#collapsible' => TRUE, 
    '#collapsed' => FALSE,
  );

  $form['attachments']['get_file'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Get Attachments'),
    '#options' => drupal_map_assoc(
      array(
        t('none'),
        t('all')
      )
    ),
    '#default_value' => array("all")
  );

  $form['attachments']['custom_files'] = array(
    '#type' => 'textfield',
    '#title' => t('Enter file extension types to be downloaded separated by commas'),
    '#description' => t('example: jpg, pdf, tiff')
  );

  $form['undo'] = array(
    '#type' => 'fieldset',
    '#title' => 'Undo',
    '#collapsible' => TRUE, 
    '#collapsed' => TRUE,
  );

  $form['undo']['batch_name'] = array(
    '#type' => 'select',
    '#title' => t('Select batch(es) to delete'),
    '#options' => drupal_map_assoc(get_batch_names()),
    '#description' => t('Permanently delete nodes in batch(es). This cannot be undone.')
  );

  $form['undo']['submit_undo'] = array(
    '#type' => 'submit',
    '#value' => t('Submit')
    //TODO: process multiple submit buttons on same page
  );

	$form['submit'] = array(
		'#type' => 'submit',
		'#value' => t('Submit'),
    '#weight' => 10
	);

	return $form;
}

function ajax_terms_callback($form, &$form_state) {
  $vid = $form_state['values']['taxonomy_list']['name'];
  $form['urls']['term_list'] = array(
    '#type' => 'select',
    '#title' => 'Terms',
    '#options' => drupal_map_assoc(get_vocabulary_list($vid))
  );

  return $form['urls']['term_list'];
}

 function link_import_config_form() {
  $form['link_import_undo'] = array(
    '#type' => 'checkbox',
    '#title' => t('Keep log of import batches to be able to undo them.')
  );

  $form['batch_name_required'] = array(
    '#type' => 'checkbox',
    '#title' => t('Require batch name?'),
    '#description' => t('Overrides setting on main page')
  );

  return $form;
 }

/**
* Validate the form.
*/
function link_import_form_validate($form, &$form_state) {
  /*
  $url = $form_state['values']['url_list'];
  if(filter_var($url, FILTER_VALIDATE_URL) == FALSE)
  {
    form_set_error('url', t("Invalid URL " . $form_state['values']['url_list']));
  }
  */
}

function link_import_form_submit($form, &$form_state) {
  $url_list = $form_state['values']['url_list'];
  $urls = get_urls($url_list);
  $content_type = $form_state['values']['content_type'];
  $regexp = "<a\s[^>]*href=(\"??)([^\" >]*?)\\1[^>]*>(.*)<\/a>";
  $bodytext = "";
  $batch_num = time();
  $batch_name = $form_state['values']['batch_name'];

  foreach($urls as $url) {
    $input = @file_get_contents($url) or die("Could not access file: $url");
    

    if(preg_match_all("/$regexp/siU", $input, $matches, PREG_SET_ORDER)) {
      foreach($matches as $match) {
        $path = $match[2];
        $text = $match[3];
        
        $node = new stdClass(); // Create a new node object
        $node->type = $content_type; // Or page, or whatever content type you like
        node_object_prepare($node); // Set some default values
        $node->title    = strip_tags($text);
        $node->language = LANGUAGE_NONE; // Or e.g. 'en' if locale is enabled
        $node->status   = 1;      //(1 or 0): published or not
        $node->promote  = 0;        //(1 or 0): promoted to front page
        $node->sticky   = 0;        //(1 or 0): sticky at top of lists
        $node->comment  = 1;        //2 = comments on, 1 = comments off
        //TODO: get id of currently logged in user
        $node->uid = 1; // UID of the author of the node; or use $node->name

        $node->body[$node->language][0]['value']   = $bodytext;
        $node->body[$node->language][0]['summary'] = text_summary($bodytext);
        $node->body[$node->language][0]['format']  = 'filtered_html';

        $source_path = $match[2];
        //TODO: only process files of specific mime-types
        $valid_mime = array('txt', 'image/jpeg', 'png', 'pdf', 'doc', 'docx', 'xls', 'xlsx');

        foreach ($valid_mime as $mime) 
        {
          if(file_get_mimetype($path) == $mime){
            $image = file_get_contents($source_path);
            $file = file_save_data($image, 'public://' . drupal_basename($source_path),FILE_EXISTS_REPLACE);
            $file->display = 1;
            $file->description = "";
            $node->field_attachment = array(
              LANGUAGE_NONE => array(
                '0' => (array)$file
              )
            );
          } 
        }


        // I prefer using pathauto, which would override the below path
        $path = 'node_created_on' . date('YmdHis');
        $node->path = array('alias' => $path);

        if($node = node_submit($node)) { // Prepare node for saving
          node_save($node);  
          batch_log($node->nid, $batch_num, $batch_name);                  
          echo "Node with nid " . $node->nid . " saved!\n";
        }
      }
    } 
  }
}

/**
 * Parse a list of URLs submitted via a textarea and put them into an array
 */
function get_urls($url_list){
  //put list of links in textarea into an array
  $urls = preg_split("/[\r\n,]+/", $url_list);
  return $urls;
}

function attach_file($source_path, $node) {
  //TODO: get mime-type and process accordingly
  $image = file_get_contents($source_path);
  $file = file_save_data($image, 'public://' . drupal_basename($source_path),FILE_EXISTS_REPLACE);
  node_object_prepare($node);
  $node->field_attachment[LANGUAGE_NONE]['0']['fid'] = $file->fid;
}

function get_taxonomy_vocabularies () {
  $taxonomies = taxonomy_get_vocabularies();
  $vocabularies = array();
  foreach($taxonomies as $t)
  {
    //$vocabularies['name'] = $t->name;
    $vocabularies[] = $t->vid;
  }

  return $vocabularies;
}

function get_vocabulary_list ($vid)
{
  //get all of the taxonomy vocabularies
  $vocabularies = taxonomy_get_vocabularies();

  //get a  vocabulary specified by vocabulary id argument
  $v = $vocabularies[$vid]->vid;

  //get the  taxonomy tree of the specified vocabulary
  $trees = taxonomy_get_tree($v);

  //store list of vocabulary items
  $key = array();
  $value = array();

  //iterate through taxonomy tree and add item name to list
  foreach ($trees as $tree)
  {
    $key[]  = "$tree->vid";
    $value[] = "$tree->name";
  }

  return array_combine($key, $value);
}

function batch_log($nid, $batch_num, $batch_name) 
{
  $table = "link_import_log";
  $record = array(
    'nid' => $nid,
    'batch_num' => $batch_num,
    'batch_name' => $batch_name
  );

  drupal_write_record($table, $record);

  return;
}

function link_import_schema()
{
  $schema['link_import_log'] = array(
    'description' => 'Store import batch IDs for undo',
    'fields' => array(
      'lid' => array(
        'description' => 'link import id',
        'type' => 'serial',
        'not null' => TRUE,
      ),
      'batch_num' => array(
        'description' => 'batch number',
        'type' => 'int',
        'not null' => TRUE,
      ),
      'nid' => array(
        'description' => 'node id',
        'type' => 'int',
        'not null' => TRUE,
      ),
      'batch_name' => array(
        'description' => 'TODO: please describe this field!',
        'type' => 'varchar',
        'length' => '50',
        'not null' => TRUE,
      ),
    ),
    'primary key' => array('lid'),
  );

  return $schema;
}

function get_batch_names()
{
  return array('foo', 'bar');
}